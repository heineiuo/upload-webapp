/*! PURPLE.js v0.6.0 2015-07-18 */
!function(a){function b(){function a(a){function c(a){return"undefined"==typeof h.app[a.name]?b(a):h.app[a.name]}return"undefined"==typeof a?c({name:"__anonymous"}):"string"==typeof a?c({name:a}):"object"==typeof a?c(f({name:"__anonymous"},a)):void 0}function b(a){console.log("正在创建app:"+a.name);var b=f({filter:{},spa:!1,timeout:45e3,exceptionHandler:function(a,b,c,d){a?(console.error(a),c.end()):d()},notFoundHandle:function(a,b){b.end()}},a),e=c({spa:!1,complete:!0,prevUrl:null,curUrl:location.href},b);return h.app[a.name]={conf:b,state:e,middleware:[],list:{},set:function(a,b){var d=this,g=f({},d.conf);"object"==typeof a?g=f(g,a):g[a]=b,g.name=d.conf.name,d.state=c(e,g),d.conf=g},use:function(a){this.middleware.push(a)},route:function(a){var b,c=this;if(a instanceof Array)b=new RegExp("(^"+a.join("$)|(^")+"$)");else if("string"==typeof a)b=new RegExp("^"+a+"$");else{if(!(a instanceof RegExp))return!1;b=a}return c.list[b]={regexp:b,get:function(){this.fns=Array.prototype.slice.call(arguments,0)}},c.list[b]},go:function(a,b){function c(a){"undefined"!=typeof a&&null!=a?g.conf.exceptionHandler(a,h,i,c):g.state.complete||(j.length>0?j.shift()(h,i,c):i.end())}function e(a,b,c){console.log("正在解析地址："+a.rawUrl);var d=a.parsedUrl,e=!0,f=d.match(g.conf.filter.pathname);if(f)if("undefined"!=typeof g.conf.filter.search){console.log("路由模式切换为使用searches参数:"+g.conf.filter.search);var h=g.conf.filter.search;d="undefined"!=typeof a.searches[h]&&""!=a.searches[h]?a.searches[h]:"/"}else d=a.pathname.substr(Object(f[0]).length);else console.warn("routePath不符合pathname过滤规则，浏览器重定向到请求网址"),location.replace(a.rawUrl);console.log("过滤后的routePath: "+d),g.state.prevUrl=g.state.curUrl,g.state.curUrl=a.parsedUrl,g.state.spa&&("replace"==a.historyStateType?history.replaceState("data","title",a.parsedURL):history.pushState("data","title",a.parsedURL));for(var i in g.list)if(g.list.hasOwnProperty(i)&&g.list[i].regexp.test(d))return console.log("解析路由成功："+g.list[i].regexp),j=j.concat(g.middleware,g.list[i].fns),e=!1,c();e&&(console.warn("该地址无法解析："+a.rawUrl),g.conf.notFoundHandle(a,b))}var g=this;if(!g.state.complete)return!1;g.state.complete=!1;var h=f(d(a),{prevUrl:g.state.curUrl,rawUrl:a,historyStateType:b||"push"}),i={end:function(){clearTimeout(k),g.state.complete=!0,console.log("路由跳转完毕。")},redirect:function(a){this.end(),g.go(a)}},j=[e].concat(g.middleware),k=setTimeout(function(){console.warn("超时"),i.end()},g.conf.timeout);c()}},h.app[a.name]}function c(b,c){function e(b){console.log("popstateHandle"),g(function(b){b||a(c.name).go(location.href)})}function f(b){h(b,function(b,d){b||a(c.name).go(d)})}function g(b){var e=a(c.name).state.curUrl,f=location.href,g=d(e),h=d(f);b(g.pathname==h.pathname&&g.search==h.search?"HASH_CHNAGED":null)}function h(a,b){function c(a){a!=document.body&&null!=a&&("A"==a.nodeName?d="undefined"==typeof a.attributes.href?null:a.attributes.href.value:c(a.parentNode))}var d=null;c(a.target),null==d?b("HREF_NOT_FOUND"):"#"==d.substr(0,1)?b("HASH_MODE"):(a.preventDefault(),b(null,d))}return c.spa&&!b.spa?(b.spa=!0,window.addEventListener("popstate",e,!1),document.addEventListener("click",f,!1)):!c.spa&&b.spa&&(b.spa=!1,window.removeEventListener("popstate",e,!1),document.removeEventListener("click",f,!1)),b}function d(a){var b=document.createElement("a");b.href=a;var c=b.pathname||"/"+b.pathname,d={rawUrl:b.href,href:b.href,origin:b.origin,source:a,protocol:b.protocol.replace(":",""),hostname:b.hostname,port:b.port,relative:(b.href.match(/tps?:\/\/[^\/]+(.+)/)||[,""])[1],pathname:c.replace(/^([^\/])/,"/$1"),pathnames:g(b.pathname.replace(/^\//,"").split("/"),""),search:b.search,searches:function(){for(var a,c={},d=b.search.replace(/^\?/,"").split("&"),e=d.length,f=0;e>f;f++)d[f]&&(a=d[f].split("="),c[a[0]]=a[1]);return c}(),hash:b.hash.replace("#",""),hashes:g(b.hash.replace(/^(#)*/i,"").replace(/^\//,"").split("/"),""),file:(b.pathname.match(/\/([^\/?#]+)$/i)||[,""])[1]},f="/"+d.pathnames.join("/");if(!e(d.searches)){f+=String("?");for(var h in d.searches)d.searches.hasOwnProperty(h)&&(f+=h+"=",f+="undefined"!=typeof d.searches[h]?d.searches[h]:"",f+="&");f=f.substring(0,f.length-1)}if(d.hashes.length>0){f+="#";for(var i=0;i<d.hashes.length;i++)f+=i<d.hashes.length-1?d.hashes[i]+String("/"):d.hashes[i]}return d.parsedURL=f,d.parsedUrl=f,d}function e(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function f(){var a={},b=Array.prototype.slice.call(arguments,0);return b.forEach(function(b,c){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])}),a}function g(a,b){var c=[];return a.forEach(function(a){a!==b&&c.push(a)}),c}var h={app:{}};return a}"function"==typeof define&&define.amd?define(function(){return b()}):a.purple=b()}(this);